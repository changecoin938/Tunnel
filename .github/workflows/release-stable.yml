name: Stable Release (Linux)

on:
    workflow_dispatch:
    push:
        branches:
            - "main"

permissions:
    contents: write

jobs:
    tag-stable-latest:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Update moving tag (stable-latest)
              run: |
                  set -euo pipefail
                  git config --global --add safe.directory "$GITHUB_WORKSPACE"
                  git tag -f stable-latest "$GITHUB_SHA"
                  git push --force origin "refs/tags/stable-latest"

    build-linux:
        runs-on: ubuntu-latest
        needs: [tag-stable-latest]
        container:
            image: golang:1.25
        strategy:
            matrix:
                goarch: [amd64, arm64]

        steps:
            - name: Setup Build Environment
              run: |
                  set -euo pipefail
                  apt-get update
                  if [ "${{ matrix.goarch }}" = "arm64" ]; then
                    dpkg --add-architecture arm64
                    apt-get update
                    apt-get install -y --no-install-recommends gcc-aarch64-linux-gnu libc6-dev-arm64-cross libpcap-dev:arm64
                  else
                    apt-get install -y --no-install-recommends build-essential libpcap-dev
                  fi

            - name: Checkout Code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Mark repo as safe
              run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

            - name: Build
              run: |
                  set -euo pipefail
                  mkdir -p dist
                  export CGO_ENABLED=1
                  export GOOS=linux
                  export GOARCH=${{ matrix.goarch }}
                  export VERSION="stable-latest"
                  export GIT_COMMIT="$(git rev-parse HEAD 2>/dev/null || echo "unknown")"
                  export GIT_TAG="$(git describe --tags --exact-match 2>/dev/null || echo "unknown")"
                  export BUILD_TIME="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"

                  if [ "$GOARCH" = "arm64" ]; then
                    export CC=aarch64-linux-gnu-gcc
                  fi

                  go build -v -a -trimpath \
                    -ldflags "-s -w -buildid= \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o "paqet_linux_${GOARCH}" ./cmd/main.go

                  chmod +x "paqet_linux_${GOARCH}"
                  cp "paqet_linux_${GOARCH}" "dist/paqet-linux-${GOARCH}"
                  tar -czvf "dist/paqet-linux-${GOARCH}.tar.gz" \
                    "paqet_linux_${GOARCH}" \
                    README.md \
                    scripts/paqet-ui \
                    scripts/paqet-rootcause \
                    scripts/paqet-update \
                    scripts/paqet-iptables.sh \
                    scripts/paqet-systemd-iptables.sh \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: paqet-linux-${{ matrix.goarch }}
                  path: dist/paqet-linux-${{ matrix.goarch }}.tar.gz
                  retention-days: 7

    release:
        runs-on: ubuntu-latest
        needs: [build-linux]
        steps:
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./dist
                  pattern: paqet-linux-*
                  merge-multiple: true

            - name: Create/Update release (stable-latest)
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: stable-latest
                  name: "Stable (stable-latest)"
                  prerelease: false
                  files: dist/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
