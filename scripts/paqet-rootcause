#!/usr/bin/env bash
set -euo pipefail

# paqet-rootcause collects a best-effort support bundle on the server.
# It is read-only (does not stop/restart services) and redacts secrets from config.

SERVICE="paqet"
OUT="/tmp/paqet-rootcause-$(hostname)-$(date +%Y%m%d-%H%M%S).txt"

have() { command -v "$1" >/dev/null 2>&1; }

detect_config_path() {
  local default="/etc/paqet/config.yaml"
  if [[ -f "${default}" ]]; then
    printf "%s" "${default}"
    return 0
  fi

  if ! have systemctl; then
    printf "%s" "${default}"
    return 0
  fi

  local execstart cfg
  execstart="$(systemctl show "${SERVICE}" -p ExecStart --value 2>/dev/null || true)"
  cfg="$(printf "%s" "${execstart}" | sed -nE 's/.*-c[[:space:]]+([^ ;}]+).*/\1/p' | head -n1 | tr -d '"')"
  if [[ -n "${cfg}" && -f "${cfg}" ]]; then
    printf "%s" "${cfg}"
    return 0
  fi

  printf "%s" "${default}"
  return 0
}

redact_config() {
  local cfg="$1"
  # Redact common secret keys. Keep the rest for diagnosis.
  sed -E \
    -e 's/^([[:space:]]*(key|password|psk|secret|token):[[:space:]]*).*/\1"***REDACTED***"/' \
    "${cfg}"
}

{
  echo "=== HOST ==="
  hostname 2>/dev/null || true
  date -Is 2>/dev/null || true
  echo

  echo "=== VERSION ==="
  if have paqet; then
    paqet version 2>&1 || true
  else
    echo "paqet: not found in PATH"
  fi
  echo

  echo "=== MEM/SWAP ==="
  if have free; then free -h 2>&1 || true; fi
  echo
  if have swapon; then swapon --show 2>&1 || true; fi
  echo

  echo "=== SYSTEMD UNITS (match paqet) ==="
  if have systemctl; then
    systemctl list-unit-files --no-pager 2>&1 | grep -i paqet || true
  else
    echo "systemctl: not found"
  fi
  echo

  echo "=== paqet.service (status) ==="
  if have systemctl; then
    SYSTEMD_COLORS=0 systemctl status "${SERVICE}" --no-pager -l 2>&1 || true
  fi
  echo

  echo "=== paqet.service (cat) ==="
  if have systemctl; then
    systemctl cat "${SERVICE}" --no-pager 2>&1 || true
  fi
  echo

  echo "=== paqet.service (show) ==="
  if have systemctl; then
    systemctl show "${SERVICE}" \
      -p ExecStart -p ExecStartPre -p ExecStopPost \
      -p Restart -p RestartUSec \
      -p RuntimeMaxUSec -p WatchdogUSec -p MemoryMaxUSec \
      -p Triggers -p TriggeredBy -p NRestarts \
      --no-pager 2>&1 || true
  fi
  echo

  echo "=== TIMERS (match paqet) ==="
  if have systemctl; then
    systemctl list-timers --all --no-pager 2>&1 | grep -i paqet || true
  fi
  echo

  echo "=== WATCHDOG (paqet-watchdog.timer) ==="
  if have systemctl; then
    SYSTEMD_COLORS=0 systemctl status paqet-watchdog.timer --no-pager -l 2>&1 || true
    echo
    journalctl -u paqet-watchdog -n 200 --no-pager -o short-iso 2>&1 || true
  fi
  echo

  echo "=== CRON MATCH ==="
  (crontab -l 2>/dev/null || true) | sed 's/^/crontab(root): /'
  for f in /etc/crontab /etc/cron.d/*; do
    [[ -e "$f" ]] || continue
    grep -HnEi 'paqet|systemctl (restart|stop) paqet' "$f" || true
  done
  echo

  cfg="$(detect_config_path)"
  echo "=== CONFIG (redacted) ==="
  echo "path: ${cfg}"
  if [[ -f "${cfg}" ]]; then
    redact_config "${cfg}" | sed -n '1,240p'
  else
    echo "MISSING ${cfg}"
  fi
  echo

  echo "=== SOCKETS (ss -lntp) ==="
  if have ss; then
    ss -lntp 2>&1 | grep -E ':(2443|9999|10000|20000)\b' || true
    echo
    ss -lntp 2>&1 | grep -E '\bpaqet\b' || true
  else
    echo "ss: not found"
  fi
  echo

  echo "=== PROCESS (paqet) ==="
  if have pgrep; then
    pgrep -a paqet 2>&1 || true
  else
    ps -eo pid,ppid,cmd,%cpu,%mem,rss --sort=-rss 2>&1 | grep -E '(^\s*PID|\bpaqet\b)' || true
  fi
  echo

  echo "=== JOURNAL (paqet last 400) ==="
  if have journalctl; then
    journalctl -u "${SERVICE}" -n 400 --no-pager -o short-iso 2>&1 || true
  else
    echo "journalctl: not found"
  fi
  echo

  echo "=== KERNEL OOM last 48h ==="
  if have journalctl; then
    journalctl -k --since '48 hours ago' --no-pager 2>&1 | grep -Ei 'oom-kill|Out of memory|TCP: out of memory' || true
  fi
} >"${OUT}" 2>&1

echo "OK: ${OUT}"
tail -n 220 "${OUT}" 2>/dev/null || true
