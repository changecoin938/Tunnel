#!/usr/bin/env bash
set -euo pipefail

###############################################################################
# paqet-install  —  one-command installer for paqet v0.1.28
#
# Server:
#   curl -sL URL | bash -s -- server KEY
#
# Client:
#   curl -sL URL | bash -s -- client SERVER_IP KEY
#
# Everything else (interface, IP, MAC, port) is auto-detected.
# Override with env vars: IFACE, IP, MAC, PORT, CLIENT_PORT, SERVER_IP, KEY
###############################################################################

VERSION="v0.1.28"
REPO="changecoin938/Tunnel"
BIN_DIR="/usr/local/bin"
LIB_DIR="/usr/local/lib/paqet"
CONF_DIR="/etc/paqet"
CONF_FILE="${CONF_DIR}/config.yaml"
SERVICE_FILE="/etc/systemd/system/paqet.service"
SERVICE_NAME="paqet"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info()  { printf "${GREEN}[+]${NC} %s\n" "$*"; }
warn()  { printf "${YELLOW}[!]${NC} %s\n" "$*"; }
error() { printf "${RED}[✗]${NC} %s\n" "$*" >&2; }
die()   { error "$*"; exit 1; }

# ─── Root check ──────────────────────────────────────────────────────────────
[[ "${EUID}" -eq 0 ]] || die "Run as root"

# ─── Parse positional args ───────────────────────────────────────────────────
# server KEY
# client SERVER_IP KEY
ROLE="${1:-}"
if [[ "${ROLE}" == "server" ]]; then
  KEY="${2:-${KEY:-}}"
  [[ -n "${KEY}" ]] || die "Usage: ... | bash -s -- server KEY"
elif [[ "${ROLE}" == "client" ]]; then
  SERVER_IP="${2:-${SERVER_IP:-}}"
  KEY="${3:-${KEY:-}}"
  [[ -n "${SERVER_IP}" && -n "${KEY}" ]] || die "Usage: ... | bash -s -- client SERVER_IP KEY"
else
  echo ""
  printf "${CYAN}paqet ${VERSION} Installer${NC}\n"
  echo ""
  echo "Usage:"
  echo "  Server:  curl -sL URL | bash -s -- server YOUR_KEY"
  echo "  Client:  curl -sL URL | bash -s -- client SERVER_IP YOUR_KEY"
  echo ""
  echo "Example:"
  echo "  curl -sL https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts/paqet-install | bash -s -- server mysecretkey123"
  echo "  curl -sL https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts/paqet-install | bash -s -- client 167.235.152.44 mysecretkey123"
  echo ""
  die "First argument must be 'server' or 'client'"
fi

# ─── Auto-detect everything ──────────────────────────────────────────────────
info "Detecting network settings ..."

# Interface
IFACE="${IFACE:-$(ip -o route get 8.8.8.8 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}')}"
[[ -n "${IFACE}" ]] || die "Cannot detect network interface. Set IFACE= env var"

# IP
IP="${IP:-$(ip -4 addr show "${IFACE}" 2>/dev/null | awk '/inet /{sub(/\/.*/, "", $2); print $2; exit}')}"
[[ -n "${IP}" ]] || die "Cannot detect IP on ${IFACE}. Set IP= env var"

# Gateway MAC — try multiple methods
if [[ -z "${MAC:-}" ]]; then
  # Method 1: get gateway IP from default route, then ARP lookup
  GW_IP="$(ip route show default 2>/dev/null | awk '/via/{print $3; exit}')"
  if [[ -n "${GW_IP}" ]]; then
    ping -c1 -W2 "${GW_IP}" >/dev/null 2>&1 || true
    sleep 1
    MAC="$(ip neigh show "${GW_IP}" 2>/dev/null | awk '{print $5; exit}')"
  fi
  # Method 2: any reachable neighbor on the interface
  if [[ -z "${MAC:-}" ]]; then
    MAC="$(ip neigh show dev "${IFACE}" 2>/dev/null | awk '/REACHABLE|STALE|DELAY/{print $5; exit}')"
  fi
  # Method 3: any neighbor at all on the interface
  if [[ -z "${MAC:-}" ]]; then
    MAC="$(ip neigh show dev "${IFACE}" 2>/dev/null | awk 'NF>=5{print $5; exit}')"
  fi
  # Method 4: use arping if available
  if [[ -z "${MAC:-}" && -n "${GW_IP:-}" ]] && command -v arping >/dev/null 2>&1; then
    MAC="$(arping -c1 -I "${IFACE}" "${GW_IP}" 2>/dev/null | awk -F'[][]' '/reply/{print $2; exit}')"
  fi
fi
[[ -n "${MAC:-}" ]] || die "Cannot detect gateway MAC. Set MAC= env var or run: ip neigh"

# Ports
PORT="${PORT:-9999}"
CLIENT_PORT="${CLIENT_PORT:-20000}"

info "  Interface : ${IFACE}"
info "  IP        : ${IP}"
info "  MAC       : ${MAC}"
info "  Role      : ${ROLE}"
if [[ "${ROLE}" == "client" ]]; then
  info "  Server    : ${SERVER_IP}:${PORT}"
fi

# ─── Download binary ─────────────────────────────────────────────────────────
info "Downloading paqet ${VERSION} ..."

ARCH="$(uname -m)"
case "${ARCH}" in
  x86_64|amd64)  ASSET_TAR="paqet-linux-amd64.tar.gz"; BIN_TAR="paqet_linux_amd64" ;;
  aarch64|arm64)  ASSET_TAR="paqet-linux-arm64.tar.gz"; BIN_TAR="paqet_linux_arm64" ;;
  *) die "Unsupported arch: ${ARCH}" ;;
esac

URL="https://github.com/${REPO}/releases/download/${VERSION}/${ASSET_TAR}"
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "${TMP_DIR}"' EXIT

curl -fsSL "${URL}" -o "${TMP_DIR}/paqet.tar.gz"
tar xzf "${TMP_DIR}/paqet.tar.gz" -C "${TMP_DIR}"
[[ -f "${TMP_DIR}/${BIN_TAR}" ]] || die "Binary not found in tarball"

# Stop existing service before replacing binary
systemctl stop "${SERVICE_NAME}" 2>/dev/null || true

install -m 0755 "${TMP_DIR}/${BIN_TAR}" "${BIN_DIR}/paqet"
info "Binary installed: ${BIN_DIR}/paqet"

# ─── Install helper scripts ─────────────────────────────────────────────────
info "Installing helper scripts ..."
mkdir -p "${LIB_DIR}"

SCRIPTS_URL="https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts"
for script in paqet-iptables.sh paqet-systemd-iptables.sh; do
  curl -fsSL "${SCRIPTS_URL}/${script}" -o "${LIB_DIR}/${script}"
  chmod +x "${LIB_DIR}/${script}"
done

curl -fsSL "${SCRIPTS_URL}/paqet-update" -o "${BIN_DIR}/paqet-update"
chmod +x "${BIN_DIR}/paqet-update"

# ─── Generate config ─────────────────────────────────────────────────────────
info "Generating config ..."
mkdir -p "${CONF_DIR}"

if [[ "${ROLE}" == "server" ]]; then
cat > "${CONF_FILE}" <<YAML
role: "server"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
listen:
  addr: ":${PORT}"
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 33554432
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    max_sessions: 128
    max_streams_total: 16384
    max_streams_per_session: 4096
    smuxbuf: 16777216
    streambuf: 4194304
YAML

else
cat > "${CONF_FILE}" <<YAML
role: "client"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${CLIENT_PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 16777216
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
server:
  addr: "${SERVER_IP}:${PORT}"
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    smuxbuf: 16777216
    streambuf: 4194304
forward:
  - listen: "0.0.0.0:443"
    target: "127.0.0.1:2443"
    protocol: "tcp"
  - listen: "127.0.0.1:5555"
    target: "127.0.0.1:5555"
    protocol: "tcp"
YAML
fi

info "Config written: ${CONF_FILE}"

# ─── Install systemd service ────────────────────────────────────────────────
info "Installing systemd service ..."
cat > "${SERVICE_FILE}" <<'UNIT'
[Unit]
Description=paqet tunnel
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStartPre=/usr/local/lib/paqet/paqet-systemd-iptables.sh apply /etc/paqet/config.yaml
ExecStart=/usr/local/bin/paqet run -c /etc/paqet/config.yaml
ExecStopPost=/usr/local/lib/paqet/paqet-systemd-iptables.sh remove /etc/paqet/config.yaml
Restart=on-failure
RestartSec=1
LimitNOFILE=1048576

NoNewPrivileges=true
PrivateTmp=true
ProtectHome=true
ProtectSystem=full

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload

# ─── Start service ───────────────────────────────────────────────────────────
info "Starting paqet ..."
systemctl enable "${SERVICE_NAME}" --now 2>/dev/null || true
sleep 2

if systemctl is-active --quiet "${SERVICE_NAME}"; then
  info "paqet is running!"
else
  warn "Service not active. Check: journalctl -u paqet -f"
fi

# ─── Done ────────────────────────────────────────────────────────────────────
echo ""
printf "${GREEN}══════════════════════════════════════════${NC}\n"
info "Version : $("${BIN_DIR}/paqet" version 2>/dev/null || echo "${VERSION}")"
info "Config  : ${CONF_FILE}"
info "Status  : systemctl status paqet"
info "Logs    : journalctl -u paqet -f"
printf "${GREEN}══════════════════════════════════════════${NC}\n"
echo ""
