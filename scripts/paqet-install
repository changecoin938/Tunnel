#!/usr/bin/env bash
set -euo pipefail

###############################################################################
# paqet-install  —  one-command installer for paqet v0.1.28
#
# Server:
#   curl -sL URL | bash -s -- server IP MAC KEY
#   curl -sL URL | bash -s -- server IP MAC KEY [IFACE] [PORT]
#
# Client:
#   curl -sL URL | bash -s -- client IP MAC SERVER_IP KEY
#   curl -sL URL | bash -s -- client IP MAC SERVER_IP KEY [IFACE] [PORT]
#
###############################################################################

VERSION="v0.1.28"
REPO="changecoin938/Tunnel"
BIN_DIR="/usr/local/bin"
LIB_DIR="/usr/local/lib/paqet"
CONF_DIR="/etc/paqet"
CONF_FILE="${CONF_DIR}/config.yaml"
SERVICE_FILE="/etc/systemd/system/paqet.service"
SERVICE_NAME="paqet"

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

info()  { printf "${GREEN}[+]${NC} %s\n" "$*"; }
error() { printf "${RED}[✗]${NC} %s\n" "$*" >&2; }
die()   { error "$*"; exit 1; }

# ─── Root check ──────────────────────────────────────────────────────────────
[[ "${EUID}" -eq 0 ]] || die "Run as root"

# ─── Parse args ──────────────────────────────────────────────────────────────
ROLE="${1:-}"
URL_BASE="https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts/paqet-install"

if [[ "${ROLE}" == "server" ]]; then
  # server IP MAC KEY [IFACE] [PORT]
  IP="${2:-}"; MAC="${3:-}"; KEY="${4:-}"
  IFACE="${5:-eth0}"; PORT="${6:-9999}"
  [[ -n "${IP}" && -n "${MAC}" && -n "${KEY}" ]] || {
    echo ""
    echo "Usage:  curl -sL URL | bash -s -- server IP MAC KEY [IFACE] [PORT]"
    echo ""
    echo "  IP     = this server's public IP"
    echo "  MAC    = gateway MAC  (run: ip neigh | head)"
    echo "  KEY    = shared encryption key"
    echo "  IFACE  = network interface (default: eth0)    (run: ip link show)"
    echo "  PORT   = listen port (default: 9999)"
    echo ""
    echo "Example:"
    echo "  curl -sL ${URL_BASE} | bash -s -- server 167.235.152.44 d2:74:7f:6e:37:e3 mykey123"
    echo ""
    die "Missing required arguments"
  }

elif [[ "${ROLE}" == "client" ]]; then
  # client IP MAC SERVER_IP KEY [IFACE] [PORT]
  IP="${2:-}"; MAC="${3:-}"; SERVER_IP="${4:-}"; KEY="${5:-}"
  IFACE="${6:-ens3}"; PORT="${7:-9999}"
  CLIENT_PORT="20000"
  [[ -n "${IP}" && -n "${MAC}" && -n "${SERVER_IP}" && -n "${KEY}" ]] || {
    echo ""
    echo "Usage:  curl -sL URL | bash -s -- client IP MAC SERVER_IP KEY [IFACE] [PORT]"
    echo ""
    echo "  IP        = this server's public IP (Iran)"
    echo "  MAC       = gateway MAC  (run: ip neigh | head)"
    echo "  SERVER_IP = Kharej server IP"
    echo "  KEY       = shared encryption key"
    echo "  IFACE     = network interface (default: ens3)   (run: ip link show)"
    echo "  PORT      = server port (default: 9999)"
    echo ""
    echo "Example:"
    echo "  curl -sL ${URL_BASE} | bash -s -- client 78.157.36.135 24:e9:b3:9d:cc:fc 167.235.152.44 mykey123"
    echo ""
    die "Missing required arguments"
  }

else
  echo ""
  printf "${CYAN}paqet ${VERSION} Installer${NC}\n"
  echo ""
  echo "Server:"
  echo "  curl -sL ${URL_BASE} | bash -s -- server IP MAC KEY"
  echo ""
  echo "Client:"
  echo "  curl -sL ${URL_BASE} | bash -s -- client IP MAC SERVER_IP KEY"
  echo ""
  echo "To find your values:"
  echo "  IP    :  hostname -I | awk '{print \$1}'"
  echo "  MAC   :  ip neigh | head"
  echo "  IFACE :  ip link show"
  echo ""
  die "First argument must be 'server' or 'client'"
fi

info "Role      : ${ROLE}"
info "IP        : ${IP}"
info "MAC       : ${MAC}"
info "Interface : ${IFACE}"
if [[ "${ROLE}" == "client" ]]; then
  info "Server    : ${SERVER_IP}:${PORT}"
fi

# ─── Download binary ─────────────────────────────────────────────────────────
info "Downloading paqet ${VERSION} ..."

ARCH="$(uname -m)"
case "${ARCH}" in
  x86_64|amd64)  ASSET_TAR="paqet-linux-amd64.tar.gz"; BIN_TAR="paqet_linux_amd64" ;;
  aarch64|arm64)  ASSET_TAR="paqet-linux-arm64.tar.gz"; BIN_TAR="paqet_linux_arm64" ;;
  *) die "Unsupported arch: ${ARCH}" ;;
esac

URL="https://github.com/${REPO}/releases/download/${VERSION}/${ASSET_TAR}"
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "${TMP_DIR}"' EXIT

curl -fsSL "${URL}" -o "${TMP_DIR}/paqet.tar.gz"
tar xzf "${TMP_DIR}/paqet.tar.gz" -C "${TMP_DIR}"
[[ -f "${TMP_DIR}/${BIN_TAR}" ]] || die "Binary not found in tarball"

systemctl stop "${SERVICE_NAME}" 2>/dev/null || true
install -m 0755 "${TMP_DIR}/${BIN_TAR}" "${BIN_DIR}/paqet"
info "Binary installed"

# ─── Install helper scripts ─────────────────────────────────────────────────
info "Installing scripts ..."
mkdir -p "${LIB_DIR}"

SCRIPTS_URL="https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts"
for script in paqet-iptables.sh paqet-systemd-iptables.sh; do
  curl -fsSL "${SCRIPTS_URL}/${script}" -o "${LIB_DIR}/${script}"
  chmod +x "${LIB_DIR}/${script}"
done
curl -fsSL "${SCRIPTS_URL}/paqet-update" -o "${BIN_DIR}/paqet-update"
chmod +x "${BIN_DIR}/paqet-update"

# ─── Generate config ─────────────────────────────────────────────────────────
info "Generating config ..."
mkdir -p "${CONF_DIR}"

if [[ "${ROLE}" == "server" ]]; then
cat > "${CONF_FILE}" <<YAML
role: "server"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
listen:
  addr: ":${PORT}"
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 33554432
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    max_sessions: 128
    max_streams_total: 16384
    max_streams_per_session: 4096
    smuxbuf: 16777216
    streambuf: 4194304
YAML

else
cat > "${CONF_FILE}" <<YAML
role: "client"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${CLIENT_PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 16777216
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
server:
  addr: "${SERVER_IP}:${PORT}"
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    smuxbuf: 16777216
    streambuf: 4194304
forward:
  - listen: "0.0.0.0:443"
    target: "127.0.0.1:2443"
    protocol: "tcp"
  - listen: "127.0.0.1:5555"
    target: "127.0.0.1:5555"
    protocol: "tcp"
YAML
fi

info "Config: ${CONF_FILE}"

# ─── Systemd ────────────────────────────────────────────────────────────────
info "Installing service ..."
cat > "${SERVICE_FILE}" <<'UNIT'
[Unit]
Description=paqet tunnel
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStartPre=/usr/local/lib/paqet/paqet-systemd-iptables.sh apply /etc/paqet/config.yaml
ExecStart=/usr/local/bin/paqet run -c /etc/paqet/config.yaml
ExecStopPost=/usr/local/lib/paqet/paqet-systemd-iptables.sh remove /etc/paqet/config.yaml
Restart=on-failure
RestartSec=1
LimitNOFILE=1048576
NoNewPrivileges=true
PrivateTmp=true
ProtectHome=true
ProtectSystem=full

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable "${SERVICE_NAME}" --now 2>/dev/null || true
sleep 2

if systemctl is-active --quiet "${SERVICE_NAME}"; then
  info "paqet is running!"
else
  error "Service not active. Check: journalctl -u paqet -f"
fi

echo ""
info "Done! Config: ${CONF_FILE}"
info "Logs: journalctl -u paqet -f"
echo ""
