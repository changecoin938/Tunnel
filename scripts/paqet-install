#!/usr/bin/env bash
set -euo pipefail

###############################################################################
# paqet-install  —  one-command installer for paqet v0.1.28
#
# Server (Kharej):
#   curl -sL URL | bash -s -- server KEY
#
# Client (Iran):
#   curl -sL URL | bash -s -- client SERVER_IP KEY
#
# IP, MAC, interface are auto-detected. No questions asked.
###############################################################################

VERSION="v0.1.28"
REPO="changecoin938/Tunnel"
BIN_DIR="/usr/local/bin"
LIB_DIR="/usr/local/lib/paqet"
CONF_DIR="/etc/paqet"
CONF_FILE="${CONF_DIR}/config.yaml"
SERVICE_FILE="/etc/systemd/system/paqet.service"
SERVICE_NAME="paqet"

GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

info()  { printf "${GREEN}[+]${NC} %s\n" "$*"; }
error() { printf "${RED}[✗]${NC} %s\n" "$*" >&2; }
die()   { error "$*"; exit 1; }

[[ "${EUID}" -eq 0 ]] || die "Run as root"

# ─── Parse args ──────────────────────────────────────────────────────────────
ROLE="${1:-}"

if [[ "${ROLE}" == "server" ]]; then
  KEY="${2:-}"
  [[ -n "${KEY}" ]] || die "Usage: ... | bash -s -- server KEY"

elif [[ "${ROLE}" == "client" ]]; then
  SERVER_IP="${2:-}"; KEY="${3:-}"
  [[ -n "${SERVER_IP}" && -n "${KEY}" ]] || die "Usage: ... | bash -s -- client SERVER_IP KEY"

else
  echo ""
  printf "${CYAN}paqet ${VERSION} Installer${NC}\n\n"
  echo "  Server:  curl -sL URL | bash -s -- server KEY"
  echo "  Client:  curl -sL URL | bash -s -- client SERVER_IP KEY"
  echo ""
  die "First argument must be 'server' or 'client'"
fi

PORT="9999"
CLIENT_PORT="20000"

# ─── Auto-detect network ────────────────────────────────────────────────────
detect_network() {
  # Interface
  IFACE="$(ip -o route get 8.8.8.8 2>/dev/null | sed -n 's/.*dev \([^ ]*\).*/\1/p')"
  if [[ -z "${IFACE}" ]]; then
    die "Cannot detect interface"
  fi

  # IP — use the src from route get (most reliable)
  IP="$(ip -o route get 8.8.8.8 2>/dev/null | sed -n 's/.*src \([^ ]*\).*/\1/p')"
  if [[ -z "${IP}" ]]; then
    # fallback to interface address
    IP="$(ip -4 addr show "${IFACE}" 2>/dev/null | awk '/inet /{sub(/\/.*/, "", $2); print $2; exit}')"
  fi
  if [[ -z "${IP}" ]]; then
    die "Cannot detect IP"
  fi

  # Gateway IP
  local gw_ip
  gw_ip="$(ip route show default 2>/dev/null | sed -n 's/.*via \([^ ]*\).*/\1/p' | head -1)"
  if [[ -z "${gw_ip}" ]]; then
    die "Cannot detect gateway"
  fi

  # Gateway MAC — ping first to ensure ARP entry exists
  ping -c2 -W2 -q "${gw_ip}" >/dev/null 2>&1 || true
  sleep 1

  # Read MAC from ARP/neighbor table
  MAC=""

  # Method 1: ip neigh (specific gateway + interface)
  if [[ -z "${MAC}" ]]; then
    MAC="$(ip neigh show "${gw_ip}" dev "${IFACE}" 2>/dev/null | grep -oE '([0-9a-f]{2}:){5}[0-9a-f]{2}' | head -1)" || true
  fi

  # Method 2: ip neigh (specific gateway, any interface)
  if [[ -z "${MAC}" ]]; then
    MAC="$(ip neigh show "${gw_ip}" 2>/dev/null | grep -oE '([0-9a-f]{2}:){5}[0-9a-f]{2}' | head -1)" || true
  fi

  # Method 3: ip neigh (any entry on interface)
  if [[ -z "${MAC}" ]]; then
    MAC="$(ip neigh show dev "${IFACE}" 2>/dev/null | grep -oE '([0-9a-f]{2}:){5}[0-9a-f]{2}' | head -1)" || true
  fi

  # Method 4: arp command
  if [[ -z "${MAC}" ]]; then
    MAC="$(arp -n "${gw_ip}" 2>/dev/null | grep -oE '([0-9a-f]{2}:){5}[0-9a-f]{2}' | head -1)" || true
  fi

  # Method 5: cat /proc/net/arp
  if [[ -z "${MAC}" ]]; then
    MAC="$(grep "${gw_ip} " /proc/net/arp 2>/dev/null | grep -oE '([0-9a-f]{2}:){5}[0-9a-f]{2}' | head -1)" || true
  fi

  if [[ -z "${MAC}" ]]; then
    error "Cannot detect gateway MAC address"
    error "Gateway IP: ${gw_ip}"
    error "Interface:  ${IFACE}"
    echo ""
    echo "Debug info:"
    echo "--- ip neigh ---"
    ip neigh 2>/dev/null || true
    echo "--- arp -n ---"
    arp -n 2>/dev/null || true
    echo ""
    die "Please report the above output"
  fi
}

detect_network

info "Interface : ${IFACE}"
info "IP        : ${IP}"
info "Gateway   : ${MAC}"
info "Role      : ${ROLE}"
if [[ "${ROLE}" == "client" ]]; then
  info "Server    : ${SERVER_IP}:${PORT}"
fi

# ─── Download binary ─────────────────────────────────────────────────────────
info "Downloading paqet ${VERSION} ..."

ARCH="$(uname -m)"
case "${ARCH}" in
  x86_64|amd64)  ASSET_TAR="paqet-linux-amd64.tar.gz"; BIN_TAR="paqet_linux_amd64" ;;
  aarch64|arm64)  ASSET_TAR="paqet-linux-arm64.tar.gz"; BIN_TAR="paqet_linux_arm64" ;;
  *) die "Unsupported arch: ${ARCH}" ;;
esac

URL="https://github.com/${REPO}/releases/download/${VERSION}/${ASSET_TAR}"
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "${TMP_DIR}"' EXIT

curl -fsSL "${URL}" -o "${TMP_DIR}/paqet.tar.gz"
tar xzf "${TMP_DIR}/paqet.tar.gz" -C "${TMP_DIR}"
[[ -f "${TMP_DIR}/${BIN_TAR}" ]] || die "Binary not found in tarball"

systemctl stop "${SERVICE_NAME}" 2>/dev/null || true
install -m 0755 "${TMP_DIR}/${BIN_TAR}" "${BIN_DIR}/paqet"
info "Binary installed"

# ─── Helper scripts ──────────────────────────────────────────────────────────
info "Installing scripts ..."
mkdir -p "${LIB_DIR}"

SCRIPTS_URL="https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts"
for s in paqet-iptables.sh paqet-systemd-iptables.sh; do
  curl -fsSL "${SCRIPTS_URL}/${s}" -o "${LIB_DIR}/${s}"
  chmod +x "${LIB_DIR}/${s}"
done
curl -fsSL "${SCRIPTS_URL}/paqet-update" -o "${BIN_DIR}/paqet-update"
chmod +x "${BIN_DIR}/paqet-update"

# ─── Config ──────────────────────────────────────────────────────────────────
info "Generating config ..."
mkdir -p "${CONF_DIR}"

if [[ "${ROLE}" == "server" ]]; then
cat > "${CONF_FILE}" <<YAML
role: "server"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
listen:
  addr: ":${PORT}"
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 33554432
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    max_sessions: 128
    max_streams_total: 16384
    max_streams_per_session: 4096
    smuxbuf: 16777216
    streambuf: 4194304
YAML

else
cat > "${CONF_FILE}" <<YAML
role: "client"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${CLIENT_PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 16777216
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
server:
  addr: "${SERVER_IP}:${PORT}"
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    smuxbuf: 16777216
    streambuf: 4194304
forward:
  - listen: "0.0.0.0:443"
    target: "127.0.0.1:2443"
    protocol: "tcp"
  - listen: "127.0.0.1:5555"
    target: "127.0.0.1:5555"
    protocol: "tcp"
YAML
fi

info "Config: ${CONF_FILE}"

# ─── Systemd ────────────────────────────────────────────────────────────────
info "Installing service ..."
cat > "${SERVICE_FILE}" <<'UNIT'
[Unit]
Description=paqet tunnel
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStartPre=/usr/local/lib/paqet/paqet-systemd-iptables.sh apply /etc/paqet/config.yaml
ExecStart=/usr/local/bin/paqet run -c /etc/paqet/config.yaml
ExecStopPost=/usr/local/lib/paqet/paqet-systemd-iptables.sh remove /etc/paqet/config.yaml
Restart=on-failure
RestartSec=1
LimitNOFILE=1048576
NoNewPrivileges=true
PrivateTmp=true
ProtectHome=true
ProtectSystem=full

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable "${SERVICE_NAME}" --now 2>/dev/null || true
sleep 2

if systemctl is-active --quiet "${SERVICE_NAME}"; then
  info "paqet is running!"
else
  error "Not active. Check: journalctl -u paqet -f"
fi

echo ""
info "Done! Config: ${CONF_FILE}"
info "Logs: journalctl -u paqet -f"
echo ""
