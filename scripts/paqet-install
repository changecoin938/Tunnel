#!/usr/bin/env bash
set -euo pipefail

###############################################################################
# paqet-install  —  one-command installer for paqet v0.1.28
#
# Server (Kharej):
#   curl -sL URL | bash -s -- server KEY
#
# Client (Iran):
#   curl -sL URL | bash -s -- client SERVER_IP KEY
#
# IP, MAC, interface are auto-detected. No questions asked.
###############################################################################

VERSION="v0.1.28"
REPO="changecoin938/Tunnel"
BIN_DIR="/usr/local/bin"
LIB_DIR="/usr/local/lib/paqet"
CONF_DIR="/etc/paqet"
CONF_FILE="${CONF_DIR}/config.yaml"
SERVICE_FILE="/etc/systemd/system/paqet.service"
SERVICE_NAME="paqet"

GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

info()  { printf "${GREEN}[+]${NC} %s\n" "$*"; }
error() { printf "${RED}[✗]${NC} %s\n" "$*" >&2; }
die()   { error "$*"; exit 1; }

[[ "${EUID}" -eq 0 ]] || die "Run as root"

# ─── Parse args ──────────────────────────────────────────────────────────────
ROLE="${1:-}"
URL_BASE="https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts/paqet-install"

if [[ "${ROLE}" == "server" ]]; then
  KEY="${2:-}"
  [[ -n "${KEY}" ]] || { echo "Usage: curl -sL URL | bash -s -- server KEY"; die "Missing KEY"; }

elif [[ "${ROLE}" == "client" ]]; then
  SERVER_IP="${2:-}"; KEY="${3:-}"
  [[ -n "${SERVER_IP}" && -n "${KEY}" ]] || { echo "Usage: curl -sL URL | bash -s -- client SERVER_IP KEY"; die "Missing SERVER_IP or KEY"; }

else
  printf "${CYAN}paqet ${VERSION} Installer${NC}\n\n"
  echo "Server:  curl -sL ${URL_BASE} | bash -s -- server KEY"
  echo "Client:  curl -sL ${URL_BASE} | bash -s -- client SERVER_IP KEY"
  echo ""
  die "First argument must be 'server' or 'client'"
fi

PORT="9999"
CLIENT_PORT="20000"

# ─── Auto-detect (silent, no prompts) ────────────────────────────────────────
# Interface: the one used for default route
IFACE="$(ip -o route get 8.8.8.8 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}')" || true
[[ -n "${IFACE}" ]] || die "Cannot detect interface. Check: ip route"

# IP: primary address on that interface
IP="$(ip -4 addr show "${IFACE}" 2>/dev/null | awk '/inet /{sub(/\/.*/, "", $2); print $2; exit}')" || true
[[ -n "${IP}" ]] || die "Cannot detect IP on ${IFACE}. Check: ip addr show ${IFACE}"

# Gateway MAC: find gateway IP, ping it to populate ARP, then read
GW_IP="$(ip route show default 2>/dev/null | awk '/via/{print $3; exit}')" || true
if [[ -n "${GW_IP}" ]]; then
  # Populate ARP cache
  ping -c1 -W2 "${GW_IP}" >/dev/null 2>&1 || true
  sleep 1
fi
# Try multiple methods to get MAC
MAC="$(ip neigh show "${GW_IP}" dev "${IFACE}" 2>/dev/null | awk '{print $5; exit}')" || true
if [[ -z "${MAC}" ]]; then
  MAC="$(ip neigh show dev "${IFACE}" 2>/dev/null | awk 'NF>=5{print $5; exit}')" || true
fi
if [[ -z "${MAC}" ]]; then
  # Try arp command as fallback
  MAC="$(arp -n -i "${IFACE}" 2>/dev/null | awk 'NR>1{print $3; exit}')" || true
fi
[[ -n "${MAC}" ]] || die "Cannot detect gateway MAC. Check: ip neigh show dev ${IFACE}"

info "Detected: ${IFACE} / ${IP} / ${MAC}"

# ─── Download binary ─────────────────────────────────────────────────────────
info "Downloading paqet ${VERSION} ..."

ARCH="$(uname -m)"
case "${ARCH}" in
  x86_64|amd64)  ASSET_TAR="paqet-linux-amd64.tar.gz"; BIN_TAR="paqet_linux_amd64" ;;
  aarch64|arm64)  ASSET_TAR="paqet-linux-arm64.tar.gz"; BIN_TAR="paqet_linux_arm64" ;;
  *) die "Unsupported arch: ${ARCH}" ;;
esac

URL="https://github.com/${REPO}/releases/download/${VERSION}/${ASSET_TAR}"
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "${TMP_DIR}"' EXIT

curl -fsSL "${URL}" -o "${TMP_DIR}/paqet.tar.gz"
tar xzf "${TMP_DIR}/paqet.tar.gz" -C "${TMP_DIR}"
[[ -f "${TMP_DIR}/${BIN_TAR}" ]] || die "Binary not found in tarball"

systemctl stop "${SERVICE_NAME}" 2>/dev/null || true
install -m 0755 "${TMP_DIR}/${BIN_TAR}" "${BIN_DIR}/paqet"
info "Binary installed"

# ─── Helper scripts ──────────────────────────────────────────────────────────
info "Installing scripts ..."
mkdir -p "${LIB_DIR}"

SCRIPTS_URL="https://raw.githubusercontent.com/${REPO}/release/${VERSION}/scripts"
for s in paqet-iptables.sh paqet-systemd-iptables.sh; do
  curl -fsSL "${SCRIPTS_URL}/${s}" -o "${LIB_DIR}/${s}"
  chmod +x "${LIB_DIR}/${s}"
done
curl -fsSL "${SCRIPTS_URL}/paqet-update" -o "${BIN_DIR}/paqet-update"
chmod +x "${BIN_DIR}/paqet-update"

# ─── Config ──────────────────────────────────────────────────────────────────
info "Generating config ..."
mkdir -p "${CONF_DIR}"

if [[ "${ROLE}" == "server" ]]; then
cat > "${CONF_FILE}" <<YAML
role: "server"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
listen:
  addr: ":${PORT}"
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 33554432
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    max_sessions: 128
    max_streams_total: 16384
    max_streams_per_session: 4096
    smuxbuf: 16777216
    streambuf: 4194304
YAML

else
cat > "${CONF_FILE}" <<YAML
role: "client"
log:
  level: "warn"
debug:
  pprof: "127.0.0.1:6060"
  diag: true
network:
  interface: "${IFACE}"
  dscp: 0
  ipv4:
    addr: "${IP}:${CLIENT_PORT}"
    router_mac: "${MAC}"
  pcap:
    sockbuf: 16777216
    snaplen: 65535
    promisc: false
    immediate: true
    timeout_ms: 0
server:
  addr: "${SERVER_IP}:${PORT}"
transport:
  protocol: "kcp"
  conn: 10
  kcp:
    mode: "fast3"
    mtu: 1350
    rcvwnd: 8192
    sndwnd: 8192
    block: "aes"
    key: "${KEY}"
    guard: true
    guard_magic: "PQT1"
    smuxbuf: 16777216
    streambuf: 4194304
forward:
  - listen: "0.0.0.0:443"
    target: "127.0.0.1:2443"
    protocol: "tcp"
  - listen: "127.0.0.1:5555"
    target: "127.0.0.1:5555"
    protocol: "tcp"
YAML
fi

info "Config: ${CONF_FILE}"

# ─── Systemd ────────────────────────────────────────────────────────────────
info "Installing service ..."
cat > "${SERVICE_FILE}" <<'UNIT'
[Unit]
Description=paqet tunnel
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStartPre=/usr/local/lib/paqet/paqet-systemd-iptables.sh apply /etc/paqet/config.yaml
ExecStart=/usr/local/bin/paqet run -c /etc/paqet/config.yaml
ExecStopPost=/usr/local/lib/paqet/paqet-systemd-iptables.sh remove /etc/paqet/config.yaml
Restart=on-failure
RestartSec=1
LimitNOFILE=1048576
NoNewPrivileges=true
PrivateTmp=true
ProtectHome=true
ProtectSystem=full

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable "${SERVICE_NAME}" --now 2>/dev/null || true
sleep 2

if systemctl is-active --quiet "${SERVICE_NAME}"; then
  info "paqet is running!"
else
  error "Not active. Check: journalctl -u paqet -f"
fi

echo ""
info "Done! Config: ${CONF_FILE}"
info "Logs: journalctl -u paqet -f"
echo ""
