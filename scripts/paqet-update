#!/usr/bin/env bash
set -euo pipefail

REPO="changecoin938/Tunnel"
BIN="/usr/local/bin/paqet"
SERVICE="paqet"

need_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    exec sudo -E "$0" "$@"
  fi
}

need_root "$@"

ARCH="$(uname -m)"
case "${ARCH}" in
  x86_64|amd64)
    ASSET_RAW="paqet-linux-amd64"
    ASSET_TAR="paqet-linux-amd64.tar.gz"
    BIN_TAR="paqet_linux_amd64"
    ;;
  aarch64|arm64)
    ASSET_RAW="paqet-linux-arm64"
    ASSET_TAR="paqet-linux-arm64.tar.gz"
    BIN_TAR="paqet_linux_arm64"
    ;;
  *) echo "Unsupported arch: ${ARCH}" >&2; exit 1 ;;
esac

TAG="${1:-latest}"
if [[ "${TAG}" == "latest" ]]; then
  TAG="$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)"
  if [[ -z "${TAG}" ]]; then
    echo "Failed to resolve latest release tag" >&2
    exit 1
  fi
fi

URL_RAW="https://github.com/${REPO}/releases/download/${TAG}/${ASSET_RAW}"
URL_TAR="https://github.com/${REPO}/releases/download/${TAG}/${ASSET_TAR}"
echo "Downloading release assets for ${TAG} ..."

TMP_DIR="$(mktemp -d)"
TMP="${TMP_DIR}/asset"
BIN_CANDIDATE="${TMP}"
cleanup() {
  rm -rf "${TMP_DIR}"
}
trap cleanup EXIT

HTTP_CODE="$(curl -sSL -o "${TMP}" -w "%{http_code}" "${URL_RAW}" || true)"
if [[ "${HTTP_CODE}" != "200" ]]; then
  HTTP_CODE="$(curl -sSL -o "${TMP}" -w "%{http_code}" "${URL_TAR}" || true)"
  if [[ "${HTTP_CODE}" != "200" ]]; then
    echo "Download failed (raw=${URL_RAW}, tar=${URL_TAR})." >&2
    exit 1
  fi
  tar -xzf "${TMP}" -C "${TMP_DIR}"
  BIN_CANDIDATE="${TMP_DIR}/${BIN_TAR}"
  if [[ ! -f "${BIN_CANDIDATE}" ]]; then
    echo "Tar asset does not contain expected binary: ${BIN_TAR}" >&2
    exit 1
  fi
fi

if command -v file >/dev/null 2>&1; then
  FILE_TYPE="$(file -b "${BIN_CANDIDATE}")"
  if [[ "${FILE_TYPE}" != *ELF* ]]; then
    echo "Downloaded file is not an ELF binary: ${FILE_TYPE}" >&2
    exit 1
  fi
else
  MAGIC="$(head -c4 "${BIN_CANDIDATE}" | od -An -t x1 | tr -d ' \n')"
  if [[ "${MAGIC}" != "7f454c46" ]]; then
    echo "Downloaded file is not an ELF binary (magic=${MAGIC})" >&2
    exit 1
  fi
fi

echo "Stopping ${SERVICE} ..."
systemctl stop "${SERVICE}" 2>/dev/null || true

install -m 0755 "${BIN_CANDIDATE}" "${BIN}"

echo "Starting ${SERVICE} ..."
systemctl start "${SERVICE}"

echo "Updated successfully:"
"${BIN}" version
